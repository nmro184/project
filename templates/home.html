<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/multimonth@6.1.11/index.global.min.js"></script>
    <script src="https://code.jquery.com/jquery-3.6.0.min.js"></script>


    
    <script>
        var calender;
        var username = "{{username}}";
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendarEl.id = 'myCalendar'; // Assign id attribute
            calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek', // Change to weekly view
            // Set the date range to the current week
            editable: true, // Enable drag-and-drop
            eventDrop: function(info) {
                // When an event is dropped (i.e., its location is changed)
                // You can access the event information from the 'info' object
                var title = info.event.title;
                var eventId = info.event.id; // Get the event ID
                var newStart = info.event.start; // Get the new start date/time
                var newEnd = info.event.end; // Get the new end date/time

                var utcStart = formatDate(newStart);
                var utcEnd = formatDate(newEnd);
                var payload = {
                    id: eventId,
                    title: title,
                    start: utcStart,
                    end: utcEnd
                };
                console.log(payload)
                fetch(`/update/${username}`, {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/json'
                    },
                    body: JSON.stringify(payload)
                })
                .then(response => {
                    console.log(response)
                })
                .catch(error => {
                    console.error('Error:', error);
                });
                
            },
            eventOverlap: false, // Prevent events from overlapping
            initialDate: new Date(), // Start from today
            nowIndicator: true, // Show current time indicator
            events: [],
            scrollTime: '09:00',
            slotMinTime: '08:00:00', // Set the earliest visible time (e.g., 8 AM)
            slotMaxTime: '22:00:00', // Set the latest visible time (e.g., 6 PM)
            viewDidMount: function(view) {
                console.log('Calendar view is rendered');
                calendar.getEvents().forEach(function(event) {
                    event.remove();
                });

                addEvents();
            },
            headerToolbar: {
                left: 'prev,next today', // Add buttons for previous, next, and today
                center: 'title', // Add title to the center
                right: 'dayGridMonth,timeGridWeek,timeGridDay' // Add buttons for different views
            },
            eventColor: 'black'
            
            });
            calendar.render();
        });

    </script>
    
</head>
<body>
    <header>
        <h2 class = "welcome">{{username}}</h2>
        <a href="/" class = "logout-button">log out</a>
    </header>
    <main>
        <!-- Form for creating new tasks -->
        <form action="/create/{{username}}" class="create" id="createForm" style="display: none;">
            <div id = "welcome" class = "welcome">Add New Task</div>
            <div class = "buttons" id ="buttons-div">
                <button id = "errand-button" class ="form-type" onclick="toggleCreate(event ,'errand')">errand</button>
                <button id = "routine-button" class ="form-type" onclick="toggleCreate(event ,'routine')">routine</button>
                <button id = "habit-button" class = "form-type" onclick="toggleCreate(event , 'habit')">habit</button>
                <button class = "recurrence-button" onclick="togglerecurrence(event)"></button>
            </div>
            <input type="text" name="title" placeholder="task title">
            <input id = "start-time-input" type="datetime-local" name = "start" placeholder="start time"> 
            <input id = "end-time-input" type="datetime-local" name = "end" placeholder="end time"> 
            <div id="recurrenceForm" class ="recurrence-form" style = "display: none;">
                <label for="frequency">Frequency:</label>
                <select id="frequency" name="frequency" >
                    <option value="weekly">Weekly</option>
                    <option value="daily">Daily</option>
                    <option value="monthly">Monthly</option>
                    <!-- Add more options as needed -->
                </select><br>
              
                <label for="interval">repeat every:</label>
                <input type="number" id="interval" name="interval" min="1" value="1"><br>
              
                <label class="days-label">Days of the Week:</label><br>
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="sunday" name="daysOfWeek" value="1" style="margin-right: 5px;">
                    <label for="sunday">Sunday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="monday" name="daysOfWeek" value="2" style="margin-right: 5px;">
                    <label for="monday">Monday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="tuesday" name="daysOfWeek" value="3" style="margin-right: 5px;">
                    <label for="tuesday">Tuesday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="wednesday" name="daysOfWeek" value="4" style="margin-right: 5px;">
                    <label for="wednesday">Wednesday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="thursday" name="daysOfWeek" value="5" style="margin-right: 5px;">
                    <label for="thursday">Thursday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="friday" name="daysOfWeek" value="6" style="margin-right: 5px;">
                    <label for="friday">Friday</label>
                </div>
                
                <div class="day-checkbox" style="display: flex; align-items: center;">
                    <input type="checkbox" id="saturday" name="daysOfWeek" value="7" style="margin-right: 5px;">
                    <label for="saturday">Saturday</label>
                </div>
                


                <!-- Repeat for other days of the week -->
              
                <!-- Add more recurrence options as needed -->
            </div>
              
            <input type="submit">
        </form>
        
        <form action="/edit/{{username}}" class="edit" id="editform" style="display: none;">
            <div class = "welcome">Edit Task</div>
            <input type="text" name="title" placeholder="task title">
            <input type="datetime-local" name = "start" placeholder="start time"> 
            <input type="datetime-local" name = "end" placeholder="end time"> 
            <input type="hidden" name ="id"> 
            <input type="submit">
        </form>
        <!-- Button to toggle the form visibility -->
        <div class="line">
            <button onclick="toggleForm()" class="create-button"></button>
        </div>

        <!-- Task list container -->
        <div class="task-list" id="mydiv">
            <!-- Iterate over tasks and display them -->
            {% for task in tasks %}
                {% if task.type == 'errand' and task.done == 0 %}
                    <div class="task-card" id="task{{task.id}}">
                        <!-- Button to mark task as done -->
                        <!-- Task details -->
                        <object class="task-title"> {{task.title}} </object>
                        <button onclick="toggleEdit({{task.id}})" class = "edit-button"> edit </button>
                        <button class = "delete-button" onclick="deleteTask({{task.id}})"> delete</button>
                        <button class="done-button" onclick="done({{task.id}},'{{username}}')"> </button>
                    </div>
                {% endif %}
            {% endfor %}
            
        </div>
        <div id='calendar'></div>
    </main>
</body>
<script>
    function toggleForm() {
        var form = document.getElementById("createForm");
        if (form.style.display == "block"){
            form.style.display = "none"
        }
        else{
            form.style.display = "block"
        }
    }

    function done(task_id , username) {
        var task = document.getElementById(`task${task_id}`);
        task.style.opacity = "0.3";
    
        fetch(`/done/${task_id}/${username}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Remove the task row from the DOM after a delay
                setTimeout (function(){
                    console.log('Task marked as done successfully');
                    task.remove();
                }, 3000); // 3000 milliseconds = 3 seconds
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
            });
    }
    function toggleEdit(id){
        var editForm = document.getElementById("editform");
        if(editForm.style.display == "none"){
            editForm.style.display = "block";
                    fetch(`/api/task/${id}`)
                        .then(response => response.json())
                        .then (task => {
                            editForm.elements['title'].value = task.title;
                            editForm.elements['start'].value = task.start;
                            editForm.elements['end'].value = task.end;
                            editForm.elements['id'].value = id;
                        })
                        .catch(error => console.error('Error fetching task details:', error));  
                    }
                    else{
                        editForm.style.display = "none";
                    }
                       
    }
  
  // Function to add a new event
  function addEvent(id ,title, start, end) {
      // Create a new event object
      var newEvent = {
          title: title,
          start: start,
          end: end,
          id : id 
      }
  
      var addedEvent = calendar.addEvent(newEvent);
    return addedEvent;
  }
  function addEvents() {
    getTasks()
        .then(tasks => {
            console.log("Tasks:", tasks);
            tasks.map(task =>{
                if (task.type !== "errand") {
                    addEvent(id = task.id, title = task.title, start = task.start, end = task.end);
                }
            })
        })
        .catch(error => console.error('Error fetching tasks:', error));
}

function getTasks() {
    return fetch(`/api/tasks/${username}`)
        .then(response => response.json())
        .then(tasks => { 
            var events = tasks.map(task => ({
                title: task.title,
                start: task.start,
                end: task.end,
                id : task.id,
            }));
            return events;
        })
        .catch(error => {
            console.error('Error fetching task details:', error);
            throw error; // Propagate the error to the caller
        });
}
function deleteTask(task_id){
    fetch(`/delete/${username}/${task_id}`)
    .then(response => {
        if (!response.ok) {
            throw new Error('Network response was not ok');
        }
        location.reload();
    })
    .catch(error => {
        console.error('There was a problem with your fetch operation:', error);
    });
}
function formatDate(dateString) {
    // Parse the date string into a Date object
    var date = new Date(dateString);

    // Extract date components
    var year = date.getFullYear();
    var month = ('0' + (date.getMonth() + 1)).slice(-2); // Add leading zero if needed
    var day = ('0' + date.getDate()).slice(-2); // Add leading zero if needed
    var hours = ('0' + date.getHours()).slice(-2); // Add leading zero if needed
    var minutes = ('0' + date.getMinutes()).slice(-2); // Add leading zero if needed

    // Construct the formatted date string
    var formattedDate = year + '-' + month + '-' + day + 'T' + hours + ':' + minutes;

    return formattedDate;
}
function toggleCreate(event , type){
    event.preventDefault();
    form = document.getElementById("createForm");
    var typeInput = document.createElement("input");
    typeInput.type = "hidden"
    typeInput.name = "type"
    typeInput.value = type
    form.appendChild(typeInput);
    
    var startInput = document.getElementById("start-time-input");
    var endInput = document.getElementById("end-time-input");
    if(type == 'errand'){
        startInput.style.display = "none"
        endInput.style.display = "none"
       
    }else{
        startInput.style.display = "block"
        endInput.style.display = "block"
    }
}

function togglerecurrence(event){
    event.preventDefault()
    form = document.getElementById("recurrenceForm");
    if (form.style.display == 'none'){
        form.style.display = 'block'
    }else{
        form.style.display = 'none'
    }
}
// Add event listener to frequency select element
$('#frequency').change(function() {
    var selectedFrequency = $(this).val();
    
    // Check if frequency is daily
    if (selectedFrequency === 'daily') {
        // Hide or disable options for selecting specific days of the week
        $('.day-checkbox').hide(); // or .prop('disabled', true);
        $('.days-label').hide()
        
    } else {
        // Show or enable options for selecting specific days of the week
        $('.day-checkbox').show(); // or .prop('disabled', false);
        $('.days-label').show()
    }
});

</script>
</html>
