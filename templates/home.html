<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta http-equiv="X-UA-Compatible" content="IE=edge">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Document</title>
    <link rel="stylesheet" href="/static/style.css">
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/core@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/daygrid@6.1.11/index.global.min.js'></script>
    <script src='https://cdn.jsdelivr.net/npm/@fullcalendar/timegrid@6.1.11/index.global.min.js'></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/interaction@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/list@6.1.11/index.global.min.js"></script>
    <script src="https://cdn.jsdelivr.net/npm/@fullcalendar/multimonth@6.1.11/index.global.min.js"></script>

    
    <script>
        var calender;
        var username = "{{username}}";
        document.addEventListener('DOMContentLoaded', function() {
            var calendarEl = document.getElementById('calendar');
            calendarEl.id = 'myCalendar'; // Assign id attribute
            calendar = new FullCalendar.Calendar(calendarEl, {
            initialView: 'timeGridWeek', // Change to weekly view
            // Set the date range to the current week
            editable: true, // Enable drag-and-drop
            eventOverlap: false, // Prevent events from overlapping
            initialDate: new Date(), // Start from today
            nowIndicator: true, // Show current time indicator
            events: [
                    {
                        title: 'Meeting kjvbdfkvbdfkjvbkjdfbvkjdfbvkjdfbvk',
                        start: '2024-02-17T09:00:00',
                        end: '2024-02-17T12:00:00'
                    },
                    {
                        title: 'Lunch',
                        start: '2024-02-17T12:30:00',
                        end: '2024-02-17T13:30:00'
                    }
                    // Add more events as needed
                    ],
            scrollTime: '09:00',
            // Set the time range to display from the earliest event start time to the latest event end time
            viewDidMount: function(view) {
                console.log('Calendar view is rendered');
                // Attempt to add an event
                addEvent('New Event', '2024-02-25T10:00:00', '2024-02-25T12:00:00');
                addEvents();
            }
            });
            calendar.render();
        });

    </script>
    <style>
        /* Include any additional inline styles here */
        #createform {
            display: none;
        }
        #editform{
            display: none;
        }
    </style>
    
</head>
<body>
    <header>
        <h2 class = "welcome">{{username}}</h2>
        <button class = "logout-button">log out</button>
    </header>
    <main>
        <!-- Form for creating new tasks -->
        <form action="/create/{{username}}" class="create" id="createform" style="display: none;">
            <input type="text" name="title" placeholder="task title">
            <input type="datetime-local" name = "start" placeholder="start time"> 
            <input type="datetime-local" name = "end" placeholder="end time"> 
            <input type="submit">
        </form>
        
        <form action="/edit/{{username}}" class="edit" id="editform" style="display: none;">
            <input type="text" name="title" placeholder="task title">
            <input type="datetime-local" name = "start" placeholder="start time"> 
            <input type="datetime-local" name = "end" placeholder="end time"> 
            <input type="hidden" name ="id"> 
            <input type="submit">
        </form>
        <!-- Button to toggle the form visibility -->
        <div class="line">
            <button onclick="toggleForm()">Create new task</button>
        </div>

        <!-- Task list container -->
        <div class="tasklist" id="mydiv">
            <!-- Iterate over tasks and display them -->
            {% for task in tasks %}
                {% if task.done == 0 %}
                    <div class="taskrow" id="task{{task.id}}">
                        <!-- Button to mark task as done -->
                        <button class="done-button" onclick="done({{task.id}},'{{username}}')"> </button>
                        <!-- Task details -->
                        <object class="task"> {{task.title}} </object>
                        <object class="task">{{task.start}}</object>
                        <object class="task">{{task.end}}</object>
                        <button onclick="toggleEdit({{task.id}})" class = "edit-button"> edit </button>
                        <!-- Form to delete the task -->
                        <form action="/delete/{{username}}" >
                            <input type="hidden" name = "deleteid" value="{{task.id}}">
                            <input type="submit" value="delete" class="delete-button">
                        </form>
                    </div>
                {% endif %}
            {% endfor %}
            <div id='calendar'></div>
        </div>
    </main>
</body>
<script>
    function toggleForm() {
        var form = document.getElementById("createform");
        form.style.display = "block";
    }

    function done(task_id , username) {
        var task = document.getElementById(`task${task_id}`);
        task.style.opacity = "0.3";
    
        fetch(`/done/${task_id}/${username}`)
            .then(response => {
                if (!response.ok) {
                    throw new Error('Network response was not ok');
                }
                // Remove the task row from the DOM after a delay
                setTimeout (function(){
                    console.log('Task marked as done successfully');
                    task.remove();
                }, 3000); // 3000 milliseconds = 3 seconds
            })
            .catch(error => {
                console.error('There was a problem with your fetch operation:', error);
            });
    }
    function toggleEdit(id){
        var editForm = document.getElementById("editform");
        editForm.style.display = "block";
        fetch(`/api/task/${id}`)
                    .then(response => response.json())
                    .then (task => {
                        editForm.elements['title'].value = task.title;
                        editForm.elements['start'].value = task.start;
                        editForm.elements['end'].value = task.end;
                        editForm.elements['id'].value = id;
                    })
                    .catch(error => console.error('Error fetching task details:', error));     
    }
  
  // Function to add a new event
  function addEvent(title, start, end) {
      // Create a new event object
      var newEvent = {
          title: title,
          start: start,
          end: end
      };
  
      // Add the event to the calendar
      calendar.addEvent(newEvent);
  }
  function addEvents() {
    getTasks()
        .then(tasks => {
            console.log("Tasks:", tasks);
            tasks.map(task =>{
                addEvent(title = task.title , start = task.start , end = task.end)
            })
        })
        .catch(error => console.error('Error fetching tasks:', error));
}

function getTasks() {
    return fetch(`/api/tasks/${username}`)
        .then(response => response.json())
        .then(tasks => { 
            var events = tasks.map(task => ({
                title: task.title,
                start: task.start,
                end: task.end
            }));
            return events;
        })
        .catch(error => {
            console.error('Error fetching task details:', error);
            throw error; // Propagate the error to the caller
        });
}

</script>
</html>
